dsl_definitions:
  - &fabric_env
    host_string: { get_attribute: [ elastic_ip, aws_resource_id ]}
    user: { get_input: agent_user }
    key_filename: { get_input: private_key_path }

node_templates:
  os_config:
    type: cloudify.nodes.Root
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          implementation: fabric.fabric_plugin.tasks.run_script
          inputs:
            fabric_env: *fabric_env
            script_path: scripts/initialize.sh
    relationships:
      - target: server
        type: cloudify.relationships.contained_in

  nginx:
    type: cloudify.nodes.WebServer
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          implementation: fabric.fabric_plugin.tasks.run_script
          inputs:
            fabric_env: *fabric_env
            script_path: scripts/nginx/install.sh
    relationships:
      - target: server
        type: cloudify.relationships.contained_in
      - target: os_config
        type: cloudify.relationships.depends_on
      - target: music
        type: cloudify.relationships.connected_to
        source_interfaces:
          cloudify.interfaces.relationship_lifecycle:
            postconfigure:
              implementation: fabric.fabric_plugin.tasks.run_script
              inputs:
                fabric_env: *fabric_env
                script_path: scripts/nginx/add-upstream-def.sh

  music:
    type: cloudify.nodes.SoftwareComponent
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          implementation: fabric.fabric_plugin.tasks.run_script
          inputs:
            fabric_env: *fabric_env
            script_path: scripts/music/install.sh
        start:
          implementation: fabric.fabric_plugin.tasks.run_script
          inputs:
            fabric_env: *fabric_env
            script_path: scripts/music/start.sh
        stop:
          implementation: fabric.fabric_plugin.tasks.run_script
          inputs:
            fabric_env: *fabric_env
            script_path: scripts/music/stop.sh
        delete:
          implementation: fabric.fabric_plugin.tasks.run_script
          inputs:
            fabric_env: *fabric_env
            script_path: scripts/music/delete.sh
    relationships:
      - target: server
        type: cloudify.relationships.contained_in
      - target: os_config
        type: cloudify.relationships.depends_on
